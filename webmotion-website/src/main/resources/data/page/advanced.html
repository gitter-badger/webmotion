<!--
  #%L
  Webmotion website
  
  $Id$
  $HeadURL$
  %%
  Copyright (C) 2011 Debux
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as 
  published by the Free Software Foundation, either version 3 of the 
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public 
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-3.0.html>.
  #L%
  -->
<div id="article">

<h1>Avancé</h1>

<script type="text/javascript" src="js/generated_toc.js"></script>
<div id="generated-toc" class="generate_from_h2 generate_for_article"></div>

<div class="page-header">
    <h2 id="servlet">Architecture des servlets</h2>
</div>
<p>
    Le framework est géré par un filtre. Le filtre analyse 
    l'intégralité des requêtes entrantes et les aiguille vers une ressource statique (html, jsp, css, ...) 
    ou vers une action définie dans le fichier de mapping.
</p>

<p>
    Le filtre aiguille les requêtes de la façon suivante, si le path de l'URL ne 
    contient pas d'extension, c'est à dire si l'URL ne se termine pas par <code>.*</code>
    alors il redirige vers une action definie dans le mapping sinon il redirige 
    vers une ressource statique.
</p>

<p>
    Il est possible que des requêtes d'accès à des données statiques passent à tort dans la servlet d'actions.
    Pour éviter ce cas, il suffit d'appeller explicitement la servlet souhaitée
</p>

<p>
    <span class="label label-info">Exemple</span> Retourne sur /readme la resource statique :
</p>
<pre>
[actions]
*           /readme                                     url:/static/README
</pre>

<p>
    Vous pouvez aussi modifier le nom du fichier de mapping charger et le nom du 
    fichier de mapping utilisé pour définir une configuration par défaut en redéfinissant 
    le filtre de WebMotion ainsi :
</p>

<pre class="prettyprint">
&lt;filter&gt;
    &lt;filter-name&gt;WebMotionServer&lt;/filter-name&gt;
    &lt;filter-class&gt;org.debux.webmotion.server.WebMotionServer&lt;/filter-class&gt;
    &lt;async-supported&gt;true&lt;/async-supported&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;mapping_file_name&lt;/param-name&gt;
        &lt;param-value&gt;/mapping&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;default_mapping_file_name&lt;/param-name&gt;
        &lt;param-value&gt;/default_mapping&lt;/param-value&gt;
    &lt;/init-param&gt;
&lt;/filter&gt;
</pre>

<div class="page-header">
    <h2 id="handler">Comprendre le fonctionnement de WebMotion</h2>
</div>
<p>
    Le traitement de la requête passe par différents handlers pour réaliser 
    la demande du client web. Il y a un handler particulier qui est l'hander principal <code>MainHandler</code> qui est
    l'ordonnanceur des autres handlers. Il est redéfinissable dans le fichier de mapping 
    dans la section config anisi :
</p>
<pre>
[config]
server.main.handler.class=org.debux.webmotion.sample.MainHandlerSample
</pre>

<p>
    Par défaut WebMotion propose un ensemble d'handler :
</p>
<p>
    Comme handler principal, vous avez :
</p>
<ul>
    <li><strong>WebMotionMainHandler</strong>, permet l'ordonnancement des autres handlers et la gestion des extensions.</li>
</ul>

<p>
    Comme handlers pour la gestion des actions, vous avez :
</p>
<ul>
    <li><strong>ParametersMultipartHandler</strong>, permet la gestion des fichiers en multi-part.</li>
    <li><strong>FilterFinderHandler</strong>, recherche les filtres à appliquer.</li>
    <li><strong>ActionFinderHandler</strong>, recherche l'action à appliquer.</li>
    <li><strong>ParametersExtractorHandler</strong>, extrait les paramètres et les renomment si nécessaire.</li>
    <li><strong>ActionExecuteRenderHandler</strong>, crée le rendu si l'action est directement une vue ou une url.</li>
    <li><strong>FilterMethodFinderHandler</strong>, récupère les méthodes à exécuter pour des filtres.</li>
    <li><strong>ActionMethodFinderHandler</strong>, récupère la méthode à exécuter pour l'action.</li>
    <li><strong>ExecutorInstanceCreatorHandler</strong>, instancie les filters et l'action si nécessaire.</li>
    <li><strong>ExecutorParametersConvertorHandler</strong>, convertit les paramètres selon le type de méthode à invoquer.</li>
    <li><strong>ExecutorParametersInjectorHandler</strong>, injecte des paramètres supplémentaires en fonction du type.</li>
    <li><strong>ExecutorParametersValidatorHandler</strong>, valide les paramètres.</li>
    <li><strong>ExecutorMethodInvokerHandler</strong>, invoque les méthodes pour les filtres et l'action et retourne le rendu.</li>
</ul>

<p>
    Comme handlers pour la gestion des erreurs, vous avez :
</p>
<ul>
    <li><strong>ParametersMultipartHandler</strong>, permet la gestion des fichiers en multi-part.</li>
    <li><strong>ErrorFinderHandler</strong>, recherche l'action pour une erreur à appliquer.</li>
    <li><strong>ActionExecuteRenderHandler</strong>, crée le rendu si l'action est directement une vue ou une url.</li>
    <li><strong>ErrorMethodFinderHandler</strong>, récupère la méthode à éxecuter pour l'action.</li>
    <li><strong>ExecutorInstanceCreatorHandler</strong>, instancie l'action si nécessaire.</li>
    <li><strong>ExecutorParametersInjectorHandler</strong>, injecte des paramètres supplémentaires en fonction du type.</li>
    <li><strong>ExecutorMethodInvokerHandler</strong>, invoque les méthodes pour les filtres et l'action et retourne le rendu.</li>
</ul>

<p>
    Chaque handler doit implémenter deux méthodes : <code>init</code> appelée
    au moment de l'initialisation de la servlet et <code>handle</code> pour le traitement de la
    requête.
</p>
<pre class="prettyprint">
public class MyHandler implements WebMotionHandler {

    @Override
    public void init(InitContext context) {
        // Do process
    }

    @Override
    public void handle(Mapping mapping, Call call) {
        // Do process
    }
}
</pre>

<div class="page-header">
    <h2 id="paranamer">Paranamer</h2>
</div>
<p>
    WebMotion repose sur une bibliothèque pour retrouver les noms des paramètres d'une méthode.
    Cette bibliothèque s'appelle <a href="http://paranamer.codehaus.org/">Paranamer</a>.
    Par défaut, WebMotion avec Paranamer utilisent la compilation Java en mode debug.
</p>
<p>
    Si vous souhaitez passer la compilation sans le mode debug, il vous faudra configurer
    le mapping et paranamer ainsi :
</p>

<p>
    Pour le mapping :
</p>
<pre>
[config]
javac.debug=false
</pre>

<p>
    Pour paranamer avec Maven :
</p>
<pre class="prettyprint">
&lt;plugin&gt;
   &lt;groupId&gt;com.thoughtworks.paranamer&lt;/groupId&gt;
   &lt;artifactId&gt;paranamer-maven-plugin&lt;/artifactId&gt;
   &lt;version&gt;2.3&lt;/version&gt;
   &lt;executions&gt;
       &lt;execution&gt;
           &lt;id&gt;run&lt;/id&gt;
           &lt;configuration&gt;
               &lt;sourceDirectory&gt;${project.build.sourceDirectory}&lt;/sourceDirectory&gt;
               &lt;outputDirectory&gt;${project.build.outputDirectory}&lt;/outputDirectory&gt;
           &lt;/configuration&gt;
           &lt;goals&gt;
               &lt;goal&gt;generate&lt;/goal&gt;
           &lt;/goals&gt;
       &lt;/execution&gt;
   &lt;/executions&gt;
&lt;/plugin&gt;
</pre>

<div class="page-header">
    <h2 id="jmx">JMX</h2>
</div>
<p>
    Utiliser JMX permet d'avoir des informations sur l'exécution de WebMotion, à savoir :
</p>
<ul>
    <li>les statistiques générales sur le traitement d'une requête</li>
    <li>les statistiques des handlers sur le traitement d'une requête</li>
</ul>

<p>
    Vous trouverez également quelques opérations comme :
</p>
<ul>
    <li>le rechargement du mapping</li>
    <li>la configuration de la page d'erreur</li>
    <li>la remise à zéro des statistiques</li>
</ul>

<p>
    <span class="label label-info">Note</span> Vous pouvez accèder aux MBeans de WebMotion en utilisant <code>jconsole</code>.
</p>

<div style="text-align: center; margin: 0px 0px 20px 20px;">
    <a class="thumbnail" style="width: 700px; display:inline-block;">
        <img src="media?name=jconsole.png" alt="Jconsole" title="Jconsole" />
    </a>
</div>

<div class="well" style="text-align: center;">
    <a class="btn large" style="float:left;" href="documentation">« Documentation</a>
    <a class="btn large" style="margin: 0 auto;" href="#">Haut de page</a>
    <a class="btn primary large" style="float:right;" href="showcase/hello">Démonstration »</a>
</div>

</div>
