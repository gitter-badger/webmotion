<!--
  #%L
  Webmotion website
  
  $Id$
  $HeadURL$
  %%
  Copyright (C) 2011 Debux
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as 
  published by the Free Software Foundation, either version 3 of the 
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public 
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-3.0.html>.
  #L%
  -->
<div id="article">

<h1>Avancé</h1>

<script type="text/javascript" src="js/generated_toc.js"></script>
<div id="generated-toc" class="generate_from_h2 generate_for_article"></div>

<h2 class="page-header" id="servlet">Architecture des servlets</h2>
<p>
    Le framework est géré par un filtre. Le filtre analyse 
    l'intégralité des requêtes entrantes et les aiguille vers une ressource statique (html, jsp, css, ...) 
    ou vers une action définie dans le fichier de mapping.
</p>

<p>
    Le filtre aiguille les requêtes de la façon suivante, si le path de l'URL ne 
    contient pas d'extension, c'est à dire si l'URL ne se termine pas par <code>.\w{2,4}$</code>
    alors il redirige vers une action definie dans le mapping sinon il redirige 
    vers une ressource statique.
</p>

<p>
    Il est possible que des requêtes d'accès à des données statiques passent à tort dans la servlet d'actions.
    Pour éviter ce cas, il suffit d'appeller explicitement la servlet souhaitée ou désactiver la détection. 
    Pour plus de renseignements, veuillez vous reporter à la section <a href="mapping#config">Mapping - Config</a>.
</p>

<p>
    <span class="label label-info">Exemple</span> Retourne sur /readme la resource statique :
</p>
<pre>
[actions]
*           /readme                                     url:/static/README
</pre>

<p>
    Vous pouvez aussi modifier le nom du fichier de mapping charger en positonnant 
    le paramètre <code>mapping.file.name</code> dans le web.xml ainsi :
</p>

<pre class="prettyprint">
&lt;context-param&gt;
    &lt;param-name&gt;mapping.file.name&lt;/param-name&gt;
    &lt;param-value&gt;/mapping&lt;/param-value&gt;
&lt;/context-param&gt;
</pre>

<p>
    L'intérêt de mettre des valeurs par défaut dans le <code>web.xml</code> est 
    à la non nécessité de les redéfinir à chaque fois dans votre fichier 
    de <code>mapping</code>. Ainsi vous pouvez créer des comportements supplémentaires 
    par le biais des handlers et les définir comme fonctionnalitées principales de vos
    applications.
</p>

<h2 class="page-header" id="handler">Comprendre le fonctionnement de WebMotion</h2>
<p>
    Le traitement de la requête passe par différents handlers pour réaliser 
    la demande du client web. Il y a un handler particulier qui est l'hander principal <code>MainHandler</code> qui est
    l'ordonnanceur des autres handlers. Il est redéfinissable dans le fichier de mapping 
    dans la section config anisi :
</p>
<pre>
[config]
server.main.handler.class=org.debux.webmotion.sample.MainHandlerSample
</pre>

<p>
    Par défaut WebMotion propose un ensemble d'handler :
</p>
<p>
    Comme handler principal, vous avez :
</p>
<ul>
    <li><strong>WebMotionMainHandler</strong>, permet l'ordonnancement des autres handlers et la gestion des extensions.</li>
</ul>

<p>
    Comme handlers pour la gestion des actions, vous avez :
</p>
<ul>
    <li><strong>ParametersMultipartHandler</strong>, permet la gestion des fichiers en multi-part.</li>
    <li><strong>FilterFinderHandler</strong>, recherche les filtres à appliquer.</li>
    <li><strong>ActionFinderHandler</strong>, recherche l'action à appliquer.</li>
    <li><strong>ParametersExtractorHandler</strong>, extrait les paramètres et les renomment si nécessaire.</li>
    <li><strong>ActionExecuteRenderHandler</strong>, crée le rendu si l'action est directement une vue ou une url.</li>
    <li><strong>FilterMethodFinderHandler</strong>, récupère les méthodes à exécuter pour des filtres.</li>
    <li><strong>ActionMethodFinderHandler</strong>, récupère la méthode à exécuter pour l'action.</li>
    <li><strong>ExecutorMethodInvokerHandler</strong>, invoque les méthodes pour les filtres et l'action et retourne le rendu.</li>
</ul>

<p>
    Comme handlers pour la gestion des erreurs, vous avez :
</p>
<ul>
    <li><strong>ParametersMultipartHandler</strong>, permet la gestion des fichiers en multi-part.</li>
    <li><strong>ErrorFinderHandler</strong>, recherche l'action pour une erreur à appliquer.</li>
    <li><strong>ActionExecuteRenderHandler</strong>, crée le rendu si l'action est directement une vue ou une url.</li>
    <li><strong>ErrorMethodFinderHandler</strong>, récupère la méthode à éxecuter pour l'action.</li>
    <li><strong>ExecutorMethodInvokerHandler</strong>, invoque les méthodes pour les filtres et l'action et retourne le rendu.</li>
</ul>

<p>
    Pendant l'handler <code>ExecutorMethodInvokerHandler</code>, des handlers 
    supplémentaire sont invoqués pour chaque action et filtre :
</p>
<ul>
    <li><strong>ExecutorInstanceCreatorHandler</strong>, instancie le filtre ou l'action si nécessaire.</li>
    <li><strong>ExecutorParametersConvertorHandler</strong>, convertit les paramètres selon le type de méthode à invoquer.</li>
    <li><strong>ExecutorParametersInjectorHandler</strong>, injecte des paramètres supplémentaires en fonction du type.</li>
    <li><strong>ExecutorParametersValidatorHandler</strong>, valide les paramètres.</li>
</ul>

<p>
    Chaque handler doit implémenter deux méthodes : <code>init</code> appelée
    au moment de l'initialisation de la servlet et <code>handle</code> pour le traitement de la
    requête.
</p>
<pre class="prettyprint">
public class MyHandler implements WebMotionHandler {

    @Override
    public void init(InitContext context) {
        // Do process
    }

    @Override
    public void handle(Mapping mapping, Call call) {
        // Do process
    }
}
</pre>

<h2 class="page-header" id="config">Configuration</h2>
<p>
    Certains handlers sont configurables par le biais de méthode dans le ServerContext. 
    Dans les cas suivant il n'est pas nécessaire d'écrire de nouveau handler :
</p>
<ul>
    <li>convetisseur pour les paramètres</li>
    <li>injection de paramètre par rapport un type de donnée</li>
    <li>définition d'un contrôleur sur plusieurs fichiers de mapping.</li>
</ul>

<h3 id="converter">Convertisseur</h3>
<p>
    Les paramètres de requête sont converti par le handler <code>ExecutorParametersConvertorHandler</code>. 
    Il repose sur l'API BeanUtils d'apache, vous pouvez enregistrer vos propre convertisseur par le biais du 
    <code>ServerContext</code>.  Pour plus de renseignements, veuillez vous 
    reporter directement à l'<a href="http://commons.apache.org/beanutils/">API</a> d'apache.
</p>

<pre class="prettyprint">
public class Listener implements WebMotionServerListener {

    @Override
    public void onStart(ServerContext context) {
        context.addConverter(new Converter() {
            @Override
            public Object convert(Class type, Object value) {
                ...
            }
        }, AClass.class);
    }

    @Override
    public void onStop(ServerContext context) {
        ...
    }
}
</pre>

<h3 id="injector">Injecteur</h3>
<p>
    Certains paramètres de méthode sont directement injecté en fonction de leur type, 
    c'est le handler <code>ExecutorParametersInjectorHandler</code> qui se charge de cette tâche. 
    Vous pouvez rajouter vos propre injection de paramètre pour cela il vous faut implanter 
    l'interface <code>ExecutorParametersInjectorHandler.Injector</code>.
</p>
<pre class="prettyprint">
public class Listener implements WebMotionServerListener {

    @Override
    public void onStart(ServerContext context) {
        context.addInjector(new Injector() {
            @Override
            public Object getValue(Mapping mapping, Call call, Class<?> type, Type generic) {
                if (AClass.class.isAssignableFrom(type)) {
                    return new AClass();
                }
                return null;
            }
        });
    }

    @Override
    public void onStop(ServerContext context) {
        ...
    }
}
</pre>
<p>
    Vous pouvez directement récupérer la valeur en paramètre de méthode :
</p>
<pre class="prettyprint">
public class AController extends WebMotionController {

    public Render action(AClass aClass) {
        ...
    }

}
</pre>

<h3 id="gloabal">Contrôleur global</h3>
<p>
    Un contrôleur global permet de disposer la classe dans l'ensemble des fichiers de mapping 
    sans prendre en compte le paquetage courant du fichier de mapping. Cette fonctionnalitée 
    est disponible sur les handlers <code>FilterMethodFinderHandler</code>, <code>ActionMethodFinderHandler</code> et <code>ErrorMethodFinderHandler</code>.    
    Par exemple vous pouvez implanter un filtre pour la gestion d'une transaction
    et le définir comme global, ce qui vous permet de le disposer dans tous vos fichiers de mapping :
</p>
<pre class="prettyprint">
public class Listener implements WebMotionServerListener {

    @Override
    public void onStart(ServerContext context) {
        context.addGlobalController(org.debux.jpa.Transaction.class);
    }

    @Override
    public void onStop(ServerContext context) {
        ...
    }
}
</pre>

<p>
    Vous pouvez l'utiliser dans un fichier de mapping ainsi :
</p>
<pre>
[config]
package.base=org.debux.app

[filter]
*        /*           Transaction.begin
</pre>

<h2 class="page-header" id="paranamer">Paranamer</h2>
<p>
    WebMotion repose sur une bibliothèque pour retrouver les noms des paramètres d'une méthode.
    Cette bibliothèque s'appelle <a href="http://paranamer.codehaus.org/">Paranamer</a>.
    Par défaut, WebMotion avec Paranamer utilisent la compilation Java en mode debug.
</p>
<p>
    Si vous souhaitez passer la compilation sans le mode debug, il vous faudra configurer
    le mapping et paranamer ainsi :
</p>

<p>
    Pour le mapping :
</p>
<pre>
[config]
javac.debug=false
</pre>

<p>
    Pour paranamer avec Maven :
</p>
<pre class="prettyprint">
&lt;plugin&gt;
   &lt;groupId&gt;com.thoughtworks.paranamer&lt;/groupId&gt;
   &lt;artifactId&gt;paranamer-maven-plugin&lt;/artifactId&gt;
   &lt;version&gt;2.3&lt;/version&gt;
   &lt;executions&gt;
       &lt;execution&gt;
           &lt;id&gt;run&lt;/id&gt;
           &lt;configuration&gt;
               &lt;sourceDirectory&gt;${project.build.sourceDirectory}&lt;/sourceDirectory&gt;
               &lt;outputDirectory&gt;${project.build.outputDirectory}&lt;/outputDirectory&gt;
           &lt;/configuration&gt;
           &lt;goals&gt;
               &lt;goal&gt;generate&lt;/goal&gt;
           &lt;/goals&gt;
       &lt;/execution&gt;
   &lt;/executions&gt;
&lt;/plugin&gt;
</pre>

<h2 class="page-header" id="jmx">JMX</h2>
<p>
    Utiliser JMX permet d'avoir des informations sur l'exécution de WebMotion, à savoir :
</p>
<ul>
    <li>les statistiques générales sur le traitement d'une requête</li>
    <li>les statistiques des handlers sur le traitement d'une requête</li>
</ul>

<p>
    Vous trouverez également quelques opérations comme :
</p>
<ul>
    <li>le rechargement du mapping</li>
    <li>la configuration de la page d'erreur</li>
    <li>la remise à zéro des statistiques</li>
</ul>

<p>
    <span class="label label-info">Note</span> Vous pouvez accèder aux MBeans de WebMotion en utilisant <code>jconsole</code>.
</p>

<div style="text-align: center; margin: 0px 0px 20px 20px;">
    <a class="thumbnail" style="width: 700px; display:inline-block;">
        <img src="media?name=jconsole.png" alt="Jconsole" title="Jconsole" />
    </a>
</div>

<div class="well" style="text-align: center;">
    <a class="btn large" style="float:left;" href="documentation">« Documentation</a>
    <a class="btn large" style="margin: 0 auto;" href="#">Haut de page</a>
    <a class="btn primary large" style="float:right;" href="showcase/hello">Démonstration »</a>
</div>

</div>
