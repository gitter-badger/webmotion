<!--
  #%L
  Webmotion website
  
  $Id$
  $HeadURL$
  %%
  Copyright (C) 2011 Debux
  %%
  This program is free software: you can redistribute it and/or modify
  it under the terms of the GNU Lesser General Public License as 
  published by the Free Software Foundation, either version 3 of the 
  License, or (at your option) any later version.
  
  This program is distributed in the hope that it will be useful,
  but WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  GNU General Lesser Public License for more details.
  
  You should have received a copy of the GNU General Lesser Public 
  License along with this program.  If not, see
  <http://www.gnu.org/licenses/lgpl-3.0.html>.
  #L%
  -->
<div id="article">

<h1>Configuration of the mapping file</h1>

<script type="text/javascript" src="js/generated_toc.js"></script>
<div id="generated-toc" class="generate_from_h2 generate_for_article"></div>

<h2 class="page-header">Principle</h2>
<p>
    The principle of WebMotion is to execute an action relative to a URL or an event (an exception for instance).
    This management is possible thanks to a mapping file which lists the different links between URLs and action to perform.
    A mapping file is used to do the connection.
</p>
<p>
    The mapping file, named <code>mapping</code>, must be in the application classpath.
    It will be automatically detected and loaded at launch.
    You can have several mapping files if you are using additional WebMotion modules (called extensions).
    The mapping file contains a set of sections, all of them optional, which wille be described hereafter.
    In general, if a URL or an event matches several rules described in the mapping file, the first rule will be treated.
    The following rules will be ignored, except for the filters whose executions are linked.
</p>
<p>
   As we evoked <a href="begin#mapping">previously</a>, the mapping file contains several sections:
</p>
<ul>
    <li><code>[config]</code>&nbsp;<a href="#config">The web application configuration</a></li>
    <li><code>[errors]</code>&nbsp;<a href="#errors">The actions linked to the errors (technical and/or applicative)</a></li>
    <li><code>[filters]</code>&nbsp;<a href="#filters">The application filters</a></li>
    <li><code>[actions]</code>&nbsp;<a href="#actions">The actions linked to the application URLs</a></li>
    <li><code>[extensions]</code>&nbsp;<a href="#extensions">The extensions used by the application</a></li>
</ul>

<h2 id="comment" class="page-header">Comments</h2>
<p>
    You can add comments in the mapping file by prefixing your lines with <code>#</code>.
</p>
<p>
    <span class="label label-info">Example</span> Multi-line comment:
</p>
<pre>
# Begin comment
# End comment
</pre>

<h2 id="config" class="page-header">[config] The web application configuration</h2>
<p>
    This section enables to define some operation elements and defautl value for WebMotion.
    For example, this is the section where to specify the directory containing the application pages
    and the Java packages corresponding to the application controllers.
</p>

<h3>Syntax</h3>
<p>
    The different configuration properties can be found after the <code>[config]</code> keyword.
</p>
<pre>
[config]
</pre>

<p>
    The properties are defined in a <code>key=value</code> model. The allowed keys are the following:
</p>
<ul>
    <li>package.views</li>
    <li>package.base</li>
    <li>package.actions</li>
    <li>package.filters</li>
    <li>package.errors</li>
    <li>javac.debug</li>
    <li>server.async</li>
    <li>server.encoding</li>
    <li>server.error.page</li>
    <li>server.controller.scope</li>
    <li>server.listener.class</li>
    <li>server.main.handler.class</li>
</ul>

<h3>package.views</h3>
<p>
    The <strong>package.views</strong> property enables to define the path of all the JSP, HTML, etc. pages.
</p>
<p>
    <span class="label">Default</span> By default, the value of package.views is empty.
</p>
<p>
    <span class="label label-info">Example</span> The pages will be searched in the <code>pages</code> directory:
</p>
<pre>package.views=pages</pre>
<p>
    <span class="label label-info">Example</span> The pages will be searched in the <code>WEB-INF/pages</code> directory,
    a simple reflex to make the JSP pages unreachable for direct accesses:
</p>
<pre>package.views=WEB-INF/pages</pre>

<h3>package.base</h3>
<p>
    The <strong>package.base</strong> property enables to define the default Java package of all the application Java classes (controllers, filters, etc.).
</p>
<p>
    <span class="label">Default</span> By default, the value of package.base is empty.
</p>
<p>
    <span class="label label-info">Example</span> The Java classes will be searched in the <code>org.debux.webmotion.sample</code> package:
</p>
<pre>package.base=org.debux.webmotion.sample</pre>

<h3>package.actions</h3>
<p>
    The <strong>package.actions</strong> property enables to define the default package of classes of the application controllers.
    If a value is defined for the <code>package.base</code> key, this value will prefix the value of the <code>package.actions</code> key
    like this: <code>package.base + "." + package.actions</code>.
</p>

<p>
    <span class="label">Default</span> By default, the value of package.actions is empty.
</p>
<p>
    <span class="label label-info">Example</span> The Java action classes will be searched in the <code>org.debux.webmotion.sample.actions</code> package:
</p>
<pre>
package.actions=org.debux.webmotion.sample.actions
</pre>

<p>
    <span class="label label-info">Example</span> The Java action classes will be searched in the <code>org.debux.webmotion.sample.actions</code> package
    by using <code>package.base</code>:
</p>
<pre>
package.base=org.debux.webmotion.sample
package.actions=actions
</pre>

<h3>package.filters</h3>
<p>
    The <strong>package.filters</strong> property enables to define the default package of the classes of the application filters.
    As for the actions, the value defined for the <code>package.filters</code> key will be concatenated to the value of <code>package.base</code>
    if it is defined.
</p>
<p>
    <span class="label">Default</span> By default the value of package.filters is empty.
</p>
<p>
    <span class="label label-info">Example</span> The filter classes will searched in the <code>org.debux.webmotion.sample.filters</code> package:
</p>
<pre>package.filters=org.debux.webmotion.sample.filters</pre>
<p>
    <span class="label label-info">Example</span> The filter classes will searched in the <code>org.debux.webmotion.sample.filters</code> package
    by using <code>package.base</code> :
</p>
<pre>
package.base=org.debux.webmotion.sample
package.action=filters
</pre>

<h3>package.errors</h3>
<p>
    The property <strong>package.errors</strong> enables to define the default package of the classes for the Java errors.
    As for the actions, the value defined for the <code>package.errors</code> key will be concatenated to the value of <code>package.base</code>
    if it is defined.
</p>
<p>
    <span class="label">Default</span> By default the value of package.errors is empty.
</p>
<p>
    <span class="label label-info">Example</span> The error classes will searched in the <code>org.debux.webmotion.sample.errors</code> package :
</p>
<pre>package.errors=org.debux.webmotion.sample.errors</pre>
<p>
    <span class="label label-info">Example</span> The error classes will searched in the <code>org.debux.webmotion.sample.errors</code> package
    by using <code>package.base</code> :
</p>
<pre>
package.base=org.debux.webmotion.sample
package.errors=errors
</pre>

<h3>javac.debug</h3>
<p>
    The <strong>javac.debug</strong> property enables to define if the application must be compiled in debug mode.
    The available values are <code>true</code> or <code>false</code>.
    For more information, please refer to the <a href="advanced#paranamer">Advanced - Paranamer</a> section.
</p>
<p>
    <span class="label">Default</span> By default, the value of javac.debug is <code>true</code>.
</p>

<h3>server.async</h3>
<p>
    The <strong>server.async</strong> property enables to set all the actions in the asynchronous mode.
    The available values are <code>true</code> or <code>false</code>.
    You can specify that an action is asynchronous or vice versa in the action section.
</p>
<p>
    <span class="label">Default</span> By default, the value of server.async is <code>false</code>.
</p>

<h3>server.encoding</h3>
<p>
    The <strong>server.encoding</strong> property enables to force the encoding used to read the parameters of the HTTP request
    and to write the HTTP response.
    For more information, please refer to the javadoc on
    <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletRequest.html#setCharacterEncoding(java.lang.String)">
        ServletRequest.setCharacterEncoding(encoding)</a> and
    <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletResponse.html#setCharacterEncoding(java.lang.String)">
        ServletResponse.setCharacterEncoding(encoding)</a>.
</p>
<p>
    <span class="label">Default</span> By default, the value of server.encoding is <code>UTF-8</code>.
</p>
<p>
    <span class="label label-info">Note</span> For Tomcat, it is necessary to add the <code>URIEncoding="UTF-8"</code> attribute
    to the connector in the server.xml file:
</p>
<pre class="prettyprint">
&lt;Connector port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443"
           URIEncoding="UTF-8" /&gt;
</pre>

<h3>server.error.page</h3>
<p>
    The <strong>server.error.page</strong> property enables to specify if the error page provided by WebMotion is available.
    The available values are:
</p>
<ul>
    <li><code>enabled</code> to display the detailed error page if the error is not managed in the mapping</li>
    <li><code>disabled</code> to display a short message if the error is not managed in the mapping</li>
    <li><code>forced</code> to display the detailed error page even if the error is managed in the mapping</li>
</ul>
<p>
    <span class="label">Default</span> By default, the value of server.error.page is <code>enabled</code>.
</p>
<p>
    <span class="label label-info">Note</span> You can modify this property at any time with the JMX console.
    For more information, please refer to the <a href="advanced#jmx">Advanced - JMX</a> section.
</p>
<p>
    <span class="label label-info">Note</span> We advise you to set the property to <code>disabled</code> when the server is deployed in production.
</p>

<h3>server.controller.scope</h3>
<p>
    The <strong>server.controller.scope</strong> property enables to specify if the application is in stateful or stateless mode.
    By default, the stateless mode is activated, ie all the Java classes are the same for all the requests.
    Consequently, you cannot keep attributes in the class. The available values are:
</p>
<ul>
    <li><code>singleton</code> a single instance of the action is used for all the requests</li>
    <li><code>request</code> an instance of the action is valid throughout a request</li>
    <li><code>session</code> the same instance of the action is used for all the requests of a user</li>
</ul>
<p>
    <span class="label">Default</span> By default, the value of server.controller.scope is <code>singleton</code>.
</p>

<h3>server.listener.class</h3>
<p>
    The <strong>server.listener.class</strong> property enables to define a listener on the start and stop of the server.
    The value must be the fully qualified name of the class.
</p>
<p>
    <span class="label">Default</span> There is no default value.
</p>
<p>
    <span class="label label-info">Example</span> Implementation of a listener:
</p>
<pre class="prettyprint">
public class Listener implements WebMotionServerListener {

    @Override
    public void onStart(ServerContext context) {
        // do action
    }

    @Override
    public void onStop(ServerContext context) {
        // do action
    }
    
}
</pre>

<h3>server.main.handler.class</h3>
<p>
    The <strong>server.main.handler.class</strong> enables to define the class responsible for the action linking inside WebMotion.
    This property is only useful to extend the framework.
    For more information, please refer to the <a href="advanced#handler">Advanced - How does WebMotion work?</a> section.
</p>
<p>
    <span class="label">Default</span> By default, the value of server.main.handler.class is <code>org.debux.webmotion.server.WebMotionMainHandler</code>
</p>

<h2 id="actions" class="page-header">[actions] Action configuration</h2>
<p>
    This section enables to define an action to perform for a HTTP method and a given URL, like a view display, a HTTP redirection or a controller execution (Java method).
</p>

<h3>Syntax</h3>
<p>
    The different actions are listed after the <code>[actions]</code> keyword.
</p>
<pre>
[actions]
</pre>
<p>
    The definition of an action is done on a single line divided into 3 or 4 sections, depending on the case:
</p>
<ol>
    <li>The HTTP method(s) accepted for the specified URL</li>
    <li>The URL whose treatment to perform is specified</li>
    <li>The treatment to perform for the specified URL</li>
    <li>The definition of the default values of some parameters</li>
</ol>

<p>
    Here is the syntax to map a URL with a view:
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    <b>view:</b>&lt;page_name&gt;    &lt;parameter_name&gt;=&lt;value&gt;[,&lt;parameter_name&gt;=&lt;value&gt;]*
</pre>
<p>
    Here is the syntax to map a URL with another URL:
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    <b>url:</b>&lt;path&gt;
</pre>
<p>
    Here is the syntax to map a URL with a Java action (controller method):
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    <b>action:</b>[&lt;package_name&gt].&lt;class_name&gt.&lt;method_name&gt;    &lt;parameter_name&gt;=&lt;value&gt;[,&lt;parameter_name&gt;=&lt;value&gt;]*
</pre>
<p>
    <span class="label label-info">Note</span> The <code>action:</code> prefix is optional for the actions.
    So you can write:
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    &lt;method_name&gt;    [...]
</pre>
<p>
    Here the syntax to map a URL with an <strong>asynchronous</strong> action (controller method).
    Override the behaviour defined by the <code>server.async</code> property in the <code>[config]</code> section.
    An asynchronous request enables to differ the treatment of an action which needs an important treatment time
    (database access, access to a webservice, ...) without blocking the application server:
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    <b>async:</b>&lt;method_name&gt;    &lt;parameter_name&gt;=&lt;value&gt;[,&lt;parameter_name&gt;=&lt;value&gt;]*
</pre>
<p>
    Here is the syntax to map a URL with a <strong>synchronous</strong> action (controller method).
    Override the behaviour defined by the <code>server.async</code> property in the <code>[config]</code> section:
</p>
<pre>
&lt;http_method&gt;    &lt;url&gt;    <b>sync:</b>&lt;method_name&gt;    &lt;parameter_name&gt;=&lt;value&gt;[,&lt;parameter_name&gt;=&lt;value&gt;]*
</pre>

<h3 id="http-methods">HTTP methods</h3>
<p>
    The different HTTP methods supproted by WebMotion are: GET, POST, HEAD, PUT and DELETE.
</p>
<p>
    Only the GET and POST methods are supported in the web form (<code>&lt;form&gt;</code> tag).
    To be able to use the other methods, you will need to make AJAX requests.
</p>
<p>
    <span class="label label-info">Example</span> Definition of an action for d'une action for a single HTTP method:
</p>
<pre>
GET         &lt;URL&gt;        &lt;action&gt;
POST        &lt;URL&gt;        &lt;action&gt;
PUT         &lt;URL&gt;        &lt;action&gt;
DELETE      &lt;URL&gt;        &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> To specify that the action is to perform whatever the HTTP method, you can use the asterisk:
</p>
<pre>
*           &lt;URL&gt;        &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> To apply an action on a subset of HTTP methods, you just need to separate them with commas:
</p>
<pre>
GET,POST    &lt;URL&gt;        &lt;action&gt;
</pre>

<h3>Configuration of the URL which will be treated</h3>

<p>
    The specified URLs are always relative to your application context and must always start with a slash.
</p>
<p>
    <span class="label label-info">Example</span> To treat the URL <code>http://localhost:8080/webmotion-sample/index</code>, you must write:
</p>
<pre>
*           /index             &lt;action&gt;
</pre>
<p>
    <span class="label label-info">Example</span> To treat the URL of the root of your application, you must write:
</p>
<pre>
*           /                  &lt;action&gt;
</pre>

<p>
    The full URL is decisive for the choice of which action to perform.
    You can manage in several ways the request parameters.
</p>

<h4>Treatment according to predefined values of the request parameters</h4>
<p>
    <span class="label label-info">Example</span> You can differentiate the treatment to perform
    according to the only difference of the value of a request parameter:
</p>
<pre>
*           /user?action=save                  &lt;action1&gt;
*           /user?action=display               &lt;action2&gt;
</pre>

<h4>Retrieving of the value of a parameter to treat this value</h4>
<p>
    <span class="label label-info">Example</span> Declaration of dynamic parameter:
</p>
<pre>
*           /user?action={}                    &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> Declaration of dynamic parameter
    with renaming of the action parameter into value:
</p>
<pre>
*           /user?action={value}               &lt;action&gt;
</pre>
<p>
    <span class="label label-info">Example</span> Declaration of dynamic parameter
    with renaming for a parameter whose value contaisn only "a"s (regular expression constraint):
</p>
<pre>
*           /user?action={value:a*}            &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Note</span> The URLs containing parameters with regular expression constraint
    are more restrictive than URLs without constraints.
    So be careful about the order of the URLs in the mapping file:
</p>
<pre>
*           /user?action={value}            &lt;action1&gt;
*           /user?action={value:a*}         &lt;action2&gt; // Will never be treated, the previous line is more generic
</pre>

<h4>Pieces of dynamic URLs</h4>
<p>
    You have the same parameter functionalities but directly in the URL path,
    ie the retrieving of a URL fragment as a parameter of your action
    with the possibility of a Java pattern type expression.
</p>
<p>
    <span class="label label-info">Example</span> Declaration of dynamic parameter in the path,
    the <code>id</code> parameter can then be used in the URL treatment (action, view, etc.).
</p>
<pre>
*           /user/{id}                     &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> Declaration of dynamic parameter in the path with a pattern.
    The following rule will treat all the URLs starting with <code>/user-</code>
    and the value will be stored in the <code>id</code> parameter.
</p>
<pre>
*           /{id:user-*}            &lt;action&gt;
</pre>

<h3>Traitement de type affichage d'une vue</h3>
<p>
    Ce type de traitement permet de renvoyer une page directement par rapport à l'URL. 
    Il peut s'agir de n'importe quel type de page / contenu : HTML, JSP, fichier texte, etc.
    Pour spécifier ce type de traitement, il suffit de préfixer le traitement (l'action) par <code>view:</code>
</p>
<p>
    <span class="label label-info">Example</span> Retourne la page d'index :
</p>
<pre>
GET         /index                              <b>view:</b>index.html
</pre>
<p>
    <span class="label label-info">Example</span> Retourne la page d'index depuis le répertoire doc :
</p>
<pre>
GET         /doc/index                          <b>view:</b>doc/index.html
</pre>

<p>
    Des morceaux d'URL (morceau de chemin, paramètre) peuvent être réutilisés pour déterminer la vue à afficher.
</p>
<p>
    <span class="label label-info">Example</span> Retourne le fichier texte demander en paramètre :
</p>
<pre>
*           /text?file={}                       <b>view:</b>{file}.txt
</pre>

<h3>Redirections HTTP</h3>
<p>
    Il est possible de définir des redirections HTTP, vers des URLs absolues (en général, vers un autre domaine)
    ou relatives à l'application. Pour définir une redirection, il suffit de préfixer le traitement de l'URL par
    <code>url:</code>.
</p>
<p>
    <span class="label label-info">Example</span> Redirection vers un autre site :
</p>
<pre>
GET         /google                              <b>url:</b>http://www.google.com
</pre>
<p>
    <span class="label label-info">Example</span> Redirection vers une URL de l'application :
</p>
<pre>
GET         /foo                                 <b>url:</b>/do?param=3
</pre>

<p>
    Une fois encore, le traitement peut-être paramétrable selon l'URL traitée.
</p>
<p>
    <span class="label label-info">Example</span> Réécriture de l'URL de wikipédia dans notre site :
</p>
<pre>
GET         /wikipedia/{page}                    <b>url:</b>http://www.wikipedia.org/wiki/{page}
</pre>

<h3>Traitement Java</h3>
<p>
    Ce type de traitement est le plus courant, il s'agit d'exécuter une méthode Java (du code métier),
    qui finira son traitement en retournant un rendu (flux JSON, XML, une page JSP, etc.).
    La classe Java devra impérativement étendre la classe <a href="http://projects.debux.org/project-site/webmotion/apidocs/org/debux/webmotion/server/WebMotionController.html">WebMotionController</a>.
    À l'intérieur d'un contrôleur, il est possible d'accéder à des éléments tels que la requête, la réponse, le contexte web, la session, etc.
    Pour plus de détails, voir la section <a href="action#context">Actions Java - Contexte web</a>.
    Ce type de traitement est défini par la présence su préfixe <code>action:</code>, qui est cependant optionnel.
</p>
<p>
    <span class="label label-info">Example</span> Exécute la méthode find de la classe User :
</p>
<pre>
GET         /user/{id}                                  User.find
POST        /user/{id}                           <b>action:</b>User.edit
</pre>
<p>
    <span class="label label-info">Example</span> Exécute la méthode find de la classe User dans le paquetage user:
</p>
<pre>
GET         /user/{id}                            user.User.find
</pre>

<p>
    Les paramètres peuvent être utilisé pour déterminer la redirection à effectuer.
</p>
<p>
    <span class="label label-info">Example</span> Exécute la méthode de la classe récupérer en paramètre :
</p>
<pre>
*           /{class}/{method}                     {class}.{method}
</pre>
<p>
    Dans l'exemple ci-dessus, un appel à l'URL <code>/User/list</code> lancera l'exécution de la méthode <code>list</code>
    du contrôleur <code>User</code>.
</p>

<h4>Exemples de contrôleurs</h4>
<pre class="prettyprint">
public class User extends WebMotionController {
    public Render find(String id) {
        ...
        return ...
    }
    ...
}
</pre>

<h4>Traitement des paramètres</h4>
<p>
    Tous les paramêtres sont disponibles, même si ils n'ont pas été définis dans l'URL dans le fichier de mapping.
</p>
<p>
    WebMotion permet de faire de l'autoconvertion de paramètres basé sur <a href="http://commons.apache.org/beanutils/">Apache Commons BeanUtils</a>. 
    Ce qui permet d'avoir l'ensemble des conversions suivantes :
</p>
<ul> 
    <li>java.lang.BigDecimal (no default value)</li> 
    <li>java.lang.BigInteger (no default value)</li> 
    <li>boolean &amp; java.lang.Boolean (default to false)</li> 
    <li>byte &amp; java.lang.Byte (default to zero)</li> 
    <li>char &amp; java.lang.Character (default to a space)</li> 
    <li>java.lang.Class (no default value)</li> 
    <li>double &amp; java.lang.Double (default to zero)</li> 
    <li>float &amp; java.lang.Float (default to zero)</li> 
    <li>int &amp; java.lang.Integer (default to zero)</li> 
    <li>long &amp; java.lang.Long (default to zero)</li> 
    <li>short &amp; java.lang.Short (default to zero)</li> 
    <li>java.lang.String (default to null)</li> 
    <li>java.io.File (no default value)</li> 
    <li>java.net.URL (no default value)</li> 
    <li>java.sql.Date (no default value) (string format [yyyy-MM-dd])</li> 
    <li>java.sql.Time (no default value) (string format [HH:mm:ss])</li> 
    <li>java.sql.Timestamp (no default value) (string format [yyyy-MM-dd HH:mm:ss.fffffffff])</li> 
    <li>POJO (no default value)</li> 
    <li>java.util.Map (no default value)</li> 
    <li>java.util.Set (no default value)</li> 
    <li>java.util.List (no default value)</li> 
    <li>Arrays (no default value)</li> 
</ul>
<p>
    Si un paramètre ne peut être converti dans le type demandé par la méthode Java, c'est la valeur par défaut qui sera utilisée.
</p>

<p>
    <span class="label label-info">Example</span> Pour l'URL
    <code>http://localhost/webmotion-sample/action?<strong>param=value</strong></code> vous aurez comme méthode :
</p>
<pre class="prettyprint">
public Render action(Type param) {
    return ...
}
</pre>

<p>
    Pour pouvoir obtenir une liste ou un tabeau de valeurs, il suffit de passer plusieurs fois le même paramètre dans l'URL.
</p>
<p>
    <span class="label label-info">Example</span> Pour l'URL
    <code>http://localhost/webmotion-sample/action?<strong>param=value1&amp;param=value2</strong></code> vous aurez comme méthode :
</p>
<pre class="prettyprint">
public Render action(Type[] param) {
    return ...
}
</pre>

<p>
    Pour obtenir une Map, il faut utiliser la notation pointée respectant la syntaxe suivante : <br />
    <code>&lt;nom du paramètre correspondant à la map&gt;.&lt;clé de la map&gt;=&lt;valeur correspondante à la clé&gt;</code>
</p>
<p>
    <span class="label label-info">Example</span> Pour l'URL
    <code>http://localhost/webmotion-sample/action?<strong>param.key1=value1&amp;param.key2=value2</strong></code> vous aurez comme méthode :
</p>
<pre class="prettyprint">
public Render action(Map param) {
    // param contient les entrées suivantes :
    // key1 = value1
    // key2 = value2
    return ...
}
</pre>

<p>
    Pour obtenir un objet simple, il faut également utilisée la notation pointée : <br />
    <code>&lt;nom du paramètre correspondant à l'object&gt;.&lt;nom de l'attibut&gt;=&lt;valeur de l'attribut&gt;</code>
</p>
<p>
    <span class="label label-info">Example</span> Pour l'URL
    <code>http://localhost/webmotion-sample/action?<strong>book.isbn=007&amp;book.title=James%20Bond</strong></code> vous aurez comme méthode :
</p>
<pre class="prettyprint">
public Render action(Book book) {
    return ...
}
</pre>

<p>Avec la classe Book suivante :</p>
<pre class="prettyprint">
public class Book {
    protected String isbn;
    protected String title;

    // Getters &amp; setters
}
</pre>

<p>
    <span class="label label-info">Note</span> 
    Il est possible de combiner les types, c'est-à-dire avoir des listes d'objet ou des objets en association avec d'autres objets.
    Pour l'URL <code>http://localhost/webmotion-sample/action?<strong>users.user1.name=titi&amp;users.user1.age=10
            &amp;users.user1.address.country=ici&amp;users.user2.name=toto&amp;users.user2.age=12&amp;users.user2.address.country=la</strong></code>
    vous aurez comme méthode :
</p>
<pre class="prettyprint">
public Render action(List&lt;User&gt; users) {
    return ...
}
</pre>
<p>Avec la classe User suivante :</p>
<pre class="prettyprint">
public class User {
    protected String name;
    protected int age;
    protected Address address;

    // Getters &amp; setters
}

public class Address {
    protected String country;

    // Getters &amp; setters
}
</pre>

<h4>Valeurs par défaut des paramètres</h4>
<p>
    Il est possible de passer des paramètres aux méthodes Java ou des vues sans qu'ils n'existent dans l'URL. 
    Vous pouvez utiliser la notation pointée pour passer des objets.
</p>

<p>
    <span class="label label-info">Example</span> Exécute la méthode <code>exec</code> avec des paramètres par défaut :
</p>
<pre>
GET         /action           Action.exec    value=default,number=44
</pre>
<p>Avec la classe Action suivante :</p>
<pre class="prettyprint">
public class Action extends WebMotionController {
    public Render exec(String value, int number) {
        // value = "default"
        // number = 44
        return ...
    }
    ...
}
</pre>

<h2 id="filters" class="page-header">[filters] Configuration des filtres de l'application</h2>
<p>
    La section destinée aux filtres permet d'exécuter du traitement avant et/ou après l'action principale. 
    Les exemples classiques d'utilisation de filtres sont l'authentification, la journalisation, la géolocalisation, etc.
</p>

<h3>Syntaxe</h3>
<p>
    La configuration se trouve après le mot clé <code>[filters]</code> dans le fichier de mapping.
</p>
<pre>
[filters]
</pre>

<p>
    Voici la syntaxe pour filtrer des URLs sur une action Java :
</p>
<pre>
&lt;http_method&gt;    &lt;URL_filter&gt;    <b>action:</b>&lt;method_name&gt;    &lt;parameter_name&gt;=&lt;value&gt;[,&lt;parameter_name&gt;=&lt;value&gt;]*
</pre>
<p>
    <span class="label label-info">Note</span> Comme pour la section <code>[actions]</code>, le préfixe <code>action:</code> est facultatif pour les actions Java.
</p>

<h3>Méthode HTTP</h3>
<p>
    La syntaxe des méthodes HTTP supportées pour les filtres dans WebMotion sont décrites dans <a href="#http-methods">la section [actions]</a>.
</p>

<h3>URL</h3>
<p>
    Les URLs traitées par les filtres ont une syntaxe similaire aux URL pattern des <code>FilterServlet</code> dans le fichier <code>web.xml</code>.
    Il commence par un slash et peut comporter l'astérisque comme wildcard. 
</p>
<p>
    <span class="label label-warning">Attention</span> 
    Pour l'instant il n'est pas possible de filtrer selon les paramètres de la requête ou selon un pattern plus compliqué que l'astérisque.
</p>
<p>
    <span class="label label-info">Example</span> Filtre l'ensemble des URLs :
</p>
<pre>
*           /*                      &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> Filtre l'ensemble des URLs pour la gestion des utilisateur :
</p>
<pre>
*           /user/*                 &lt;action&gt;
</pre>

<h3>Action</h3>
<p>
    Le traitement effectué sur une URL filtrée est obligatoirement un traitement Java, par l'exécution d'une méthode d'une classe 
    héritant de la classe <a href="http://projects.debux.org/project-site/webmotion/apidocs/org/debux/webmotion/server/WebMotionFilter.html">WebMotionFilter</a>.
    Le traitement du filtre peut s'exécuter avant et / ou après l'action principale
    (définie par le choix d'une régle dans la sections <code>[actions]</code>).
    À l'intérieur de la fonction exécutée, c'est l'appel à la méthode <code>doProcess()</code> qui permet d'enchaîner avec l'exécution
    de l'action principale.
</p>
<p>
    De la même manière que dans un contrôleur, 
    il est possible d'accéder aux paramètres de la requête, 
    ainsi qu'aux divers éléments du contexte web (requête, réponse, session, etc.).
</p>

<p>
    <span class="label label-info">Example</span> Filtre l'ensemble des URLs pour l'authentification :
</p>
<pre>
*           /admin/*                Filters.auth
</pre>
<p>Avec la classe Filter suivante :</p>
<pre class="prettyprint">
public class Filters extends WebMotionFilter {
    public void auth(String token) {
        // Before filter
        doProcess();
        // After filter
    }
}
</pre>

<p>
    Dans un filtre, il est possible de retourner un rendu (une page, par exemple) au lieu d'appeler la méthode <code>doProcess</code>.
    Si un rendu est renvoyé par le filtre, l'exécution s'arrête, le traitement de l'action principale ne sera pas lancé.
    L'appel a la méthode <code>doProcess</code> n'est pas obligatoire, mais cela impliquera qu'aucun rendu ne sera retourné pour l'URL courante.
</p>
<p>
    <span class="label label-info">Example</span> Retourne vers une page si l'utilisateur n'est pas authentifié :
</p>
<pre>
*           /admin/*                Filters.auth
</pre>
<p>Avec la classe Filter suivante :</p>
<pre class="prettyprint">
public class Filters extends WebMotionFilter {
    public Render auth(String token) {
        if(token != null) {
            doProcess();
        } else {
            return renderView("index.html");
        }
        return null;
    }
}
</pre>

<h3>Valeurs par défaut des paramètres</h3>
<p>
    Il est possible de passer des paramètres aux méthodes Java sans qu'ils n'existent dans l'URL. 
    Vous pouvez utiliser la notation pointée pour passer des objets.
</p>

<p>
    <span class="label label-info">Example</span> Exécute le filtre <code>decorate</code> avec des paramètres par défaut :
</p>
<pre>
GET         /*           Decorator.decorate    value=default
</pre>
<p>Avec le filtre Decorator suivante :</p>
<pre class="prettyprint">
public class Decorator extends WebMotionFilter {
    public void decorate(String value) {
        // value = "default"
        ...
        doProcess();
        ...
    }
    ...
}
</pre>
<p>
    <span class="label label-warning">Attention</span> Si les paramètres par défaut ont les mêmes noms entre le filtre et l'action,
    les valeurs contenues pour ces paramètres seront celles définies au niveau action, et écraseront les valeurs définies au niveau filtre.
</p>

<h2 id="errors" class="page-header">[errors] Gestion des erreurs (exceptions, erreurs HTTP)</h2>
<p>
    La section <code>[errors]</code> permet d'effectuer un traitement particulier si une exception Java est levée
    ou si un retour d'erreur HTTP est rencontré.
</p>

<h3>Syntaxe</h3>
<p>
    La configuration se trouve après le mot clé <code>[errors]</code> dans le fichier de mapping.
</p>
<pre>
[errors]
</pre>

<p>
    Voici la syntaxe pour mapper une erreur sur une vue :
</p>
<pre>
&lt;error&gt;    view:&lt;page_name&gt;
</pre>
<p>
    Voici la syntaxe pour mapper une erreur sur une autre URL :
</p>
<pre>
&lt;error&gt;    url:&lt;path&gt;
</pre>
<p>
    Voici la syntaxe pour mapper une erreur sur une action Java :
</p>
<pre>
&lt;error&gt;    [action:]&lt;method_name&gt;
</pre>

<h3>Erreurs</h3>
<!--
TODO demander à Julien, il ne devrait pas y avoir de problèmes si la gestion des erreurs est faite au bon endroit
<p>
    Il est possible de préciser les codes http ou une exception Java comme déclencheur.
    Les erreurs sont priorisés par rapport à l'ordre dans le fichier, il faut 
    faire attention au cas où le code 500 est générer pour une exception sur le serveur.
</p>-->
<p>
    <span class="label label-info">Example</span> Gère le code statut HTTP 404  :
</p>
<pre>
<b>code:</b>404                &lt;action&gt;
</pre>

<p>
    Voici la liste des codes HTTP gérés :
</p>
<ul>
    <li><strong>400</strong> La syntaxe de la requête est erronée</li>
    <li><strong>401</strong> Une authentification est nécessaire pour accéder à la ressource</li>
    <li><strong>403</strong> L’authentification est refusée</li>
    <li><strong>404</strong> Document non trouvé</li>
    <li><strong>408</strong> Temps d’attente d’une réponse du serveur écoulé</li>
    <li><strong>500</strong> Erreur interne du serveur</li>
</ul>

<p>
    <span class="label label-info">Example</span> Gère l'ensemble des exceptions de l'application :
</p>
<pre>
java.lang.Exception           &lt;action&gt;
</pre>

<p>
    <span class="label label-info">Example</span> Gère toutes les erreurs (exceptions, code HTTP)  :
</p>
<pre>
*                       &lt;action&gt;
</pre>

<h3>Action</h3>
<p>
    Les actions pour les erreurs peuvent être une vue, une URL ou une méthode Java.
    La classe Java de gestion des erreurs doit, comme pour la section <code>[actions]</code>,
    étendre la classe <a href="http://projects.debux.org/project-site/webmotion/apidocs/org/debux/webmotion/server/WebMotionController.html">WebMotionController</a>. Cependant, dans ce contexte, il est possible d'accéder
    aux informations de l'erreur rencontrée.
</p>
<pre class="prettyprint">
public class Error extends WebMotionController {
    
    public Render display(ErrorData errorData) {
        // do
    }

}
</pre>

<p>
    Il est également possible de récupérer direction l'exception en paramètre de l'action :
</p>
<pre class="prettyprint">
public class Error extends WebMotionController {
    
    public Render display(Exception exception) {
        // do
    }

}
</pre>
<p>Avec, comme définition dans le fichier de mapping :</p>
<pre>[errors]
java.lang.Exception           Error.display
</pre>

<h2 id="extensions" class="page-header">[extensions] Gestion des extensions de l'application</h2>
<p>
    Il est possible de créer des morceaux applicatifs, avec des fichiers de mapping dédiés, et de les appliquer sur un
    sous contexte applicatif (un chemin spécifié, relatif à l'application courante). Ces morceaux applicatifs sont appelés
    des <strong>extensions</strong>. Dans une application, il est possible d'utiliser une ou plusieurs extensions 
    au sein d'un même projet.
</p>
<p>
    Pour plus de détails concernant la théorie sur les extensions et des exemples concrets, rendez-vous à la rubrique <a href="extensions">Extensions</a>
</p>

<h3>Syntaxe</h3>
<p>
    La configuration se trouve après le mot clé <code>[extensions]</code> dans le fichier de mapping.
</p>
<pre>
[extensions]
</pre>

<p>
    Voici la syntaxe pour monter une extension :
</p>
<pre>
&lt;URL&gt;    &lt;nom du fichier de mapping de l'extension&gt;
</pre>

<h3>URL</h3>
<p>
    Une extension est appliquée sur un path donné. 
    Si une extension ne retourne aucun rendu (page, flux JSON, etc.), 
    le traitement continue sur l'extension suivante.
    Les extensions peuvent être monter sur un même URL, 
    c'est la première extension qui renvoi un rendu sera prise en compte.
    Il est possible d'utiliser plusieurs fois la même extension pour plusieurs URLs.
</p>
<p>
    <span class="label label-info">Example</span> Utilisation de l'extension wikimotion :
</p>
<pre>
/wiki                  &lt;wikimotion&gt;
</pre>

<h3>Fichier de mapping</h3>
<p>
    Le fichier de mapping de chaque extension doit être dans classpath de l'application.
</p>
<p>
    <span class="label label-info">Example</span> Utilisation du fichier de mapping wikimotion :
</p>
<pre>
/wiki                  wikimotion
</pre>
<p>
    Dans le cas ci-dessus, le fichier <code>wikimotion</code>, qui doit être présent
    dans le classpath de l'application, contient toutes les règles de mapping
    de l'extension, qui seront appliquées relativement au chemin <code>/wiki</code>
</p>

<p>
    L'url de l'extension peut être un pattern sur des fichiers , 
    ce qui permet de charger des mappings de façon dynamique.
</p>
<p>
    <span class="label label-info">Example</span> Chargement des extensions des fichiers
    dans le répertoire <code>META-INF</code> avec comme extension <code>wm</code> :
</p>
<pre>
/                      META-INF/.*\.wm
</pre>

<p>
    Les filtres des extensions sont cumulables. Cela signifie qu'il est possible que le traitement d'une requête passe 
    par un ou plusieurs filtres avant d'être lancé par l'action définie dans le mapping applicatif. 
</p>
<p>
    <span class="label label-info">Example</span> Un module de mesure d'audience (statistiques) pourrait
    être utilisé par une application, qui contiendra le morceau de configuration suivant :
</p>
<pre>[extensions]
/                  statistiques
</pre>

<p>Avec le fichier de mapping du module, nommé statistiques, comme-suit :</p>
<pre>
[config]
package.base=org.debux.webmotion.stats

[filters]
*          /*                  Stats.count
</pre>

<div class="well" style="text-align: center;">
    <a class="btn large" style="float:left;" href="documentation">« Documentation</a>
    <a class="btn large" style="margin: 0 auto;" href="#">Haut de page</a>
    <a class="btn primary large" style="float:right;" href="action">Action Java »</a>
</div>

</div>